<!DOCTYPE html>  <html> <head>   <title>watch.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               watch.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><a href="https://github.com/venalis/node-watch">Node-watch</a> Is a small <a href="http://www.nodejs.org/">nodejs</a> 
module/lib to watch for file changes.
Filechanges are: </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This program is free software: you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation, either version 3 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> * </span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> * </span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program.  If not, see &lt;http://www.gnu.org/licenses&gt;.</span>
<span class="cm"> * </span>
<span class="cm"> */</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <ol>
<li>changes where the mtime (make-time) of file's changes.</li>
<li>Files added to a watched folder</li>
<li>Files deleted from a watched folder</li>
</ol>

<p>Merged https://github.com/tigerbot version </p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h4>Install:</h4>

<p>Local (in "./node_modules"):</p>

<p>npm install nodewatch</p>

<p>Global :</p>

<p>npm install nodewatch -g</p>

<h4>Usage:</h4>

<p>var watch = require('nodewatch');</p>

<p>// Adding 2 dirs relative from process.cwd()
  // Adding Abolute paths works as well
  // (Nested dirs are not watched)
  // and add the callback</p>

<pre><code> watch.add("./spec").add("./lib/watch")
 .onChange(function myWatch(file,prev,curr,action){

   console.log(file);
   console.log(prev.mtime);
   console.log(curr.mtime);
   console.log(action);
 });

 // Clear (remove) the listeners
 watch.clearListeners();

 // Remove dirs to watch
 watch.remove("./spec").remove("./lib/watch");
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p><em>nodejs requirements: EventEmitter, fs, path, util</em></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">EventEmitter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">).</span><span class="nx">EventEmitter</span><span class="p">,</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;util&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h2>Watch class declaration</h2>

<p>extends from <a href="http://nodejs.org/api/events.html#events.EventEmitter">EventEmitter</a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">WatchClass</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="s2">&quot;use strict&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h3>PUBLIC METHODS</h3>

<hr />             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>Watch class Constructor</h2>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="kd">function</span> <span class="nx">Watch</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Call the super constructor first to initialize the emitter</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>objects to track the files and directories we are explicitly
told to watch, and the files and directories that we're watching
because they are in directories we're explicitly to to watch</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">__topLvlWatchers</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__watchedItems</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">util</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">Watch</span><span class="p">,</span> <span class="nx">EventEmitter</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h2>Public method: add(path , [recursive])</h2>

<p><code>path</code> is an absolute or relative path
to a file or dir to add (watch),</p>

<p><code>recursive</code> is the flag to allow search in subfolders
(false by default)</p>

<p>returns this object</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nx">Watch</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">add</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str_file_or_path</span><span class="p">,</span> <span class="nx">recursive</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">recursive</span> <span class="o">=</span> <span class="nx">recursive</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__handle</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">str_file_or_path</span><span class="p">,</span> <span class="nx">recursive</span><span class="p">);</span>
  <span class="p">};</span>
  </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h2>Public method: remove(path)</h2>

<p><code>path</code> is a absolute or relative path
to a file or dir to remove (unwatch),</p>

<p>returns this object</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nx">Watch</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">remove</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str_file_or_path</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>we don't really need to specify recursive here,
__handle doesn't use it anyway if add isn't true</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__handle</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="nx">str_file_or_path</span><span class="p">);</span>
  <span class="p">};</span>
  </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h2>Public method: onChange(callback)</h2>

<p>add a callback <em>cb</em> :</p>

<p>function(file,prev,curr,action){
    /* do something with file,prev,curr */
   };</p>

<p>When an event triggers, 4 arguments are send to the callback listener</p>

<ul>
<li>file String, absolute filepath</li>
<li>prev <a href="http://nodejs.org/docs/v0.4.8/api/fs.html#fs.watchFile">stats objects</a></li>
<li>curr <a href="http://nodejs.org/docs/v0.4.8/api/fs.html#fs.watchFile">stats objects</a></li>
<li>the action 'delete' || 'change' || 'new'</li>
</ul>

<p>and return <em>this</em> object</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nx">Watch</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onChange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">cb</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Non-function provided as the callback for onChange&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>
  </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h3>Public method: clearListeners()</h3>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nx">Watch</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clearListeners</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">removeAllListeners</span><span class="p">(</span><span class="s2">&quot;change&quot;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">removeAllListeners</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>
  </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h3>PRIVATE METHODS</h3>

<hr />             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h2>Private method: __handle(boolean, string)</h2>

<p>String is a absolute or relative path
to a file or dir. </p>

<p>First <em>str_file_or_path</em> is normalized as a valid path, relative paths
are made absolute depending on process.cwd()</p>

<p>The boolean <em>add</em> (true == add, false == remove) is passed to
the <em>_file or _</em>dir method</p>

<p>returns this object</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nx">Watch</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__handle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">add</span><span class="p">,</span> <span class="nx">str_file_or_path</span><span class="p">,</span> <span class="nx">recursive</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">str_file_or_path</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">str_file_or_path</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>__handle is only called by the public add/remove functions,
so we can add/remove anything that gets to this point to/from
the list of explicitly watched items</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">add</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__topLvlWatchers</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">str_file_or_path</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Only add when it's not allready there</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">__topLvlWatchers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">str_file_or_path</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__topLvlWatchers</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">str_file_or_path</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">__topLvlWatchers</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Do not proccess deleted files</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">stat</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">try</span><span class="p">{</span>
      <span class="nx">stat</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="nx">str_file_or_path</span><span class="p">);</span>
    <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">add</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>We should throw on 'add' to be backwards compatible
On the public interface</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">stat</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>If the file is deleted but still being watched make sure
we remove the listeners for it.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">__watchedItems</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">str_file_or_path</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">fs</span><span class="p">.</span><span class="nx">unwatchFile</span><span class="p">(</span><span class="nx">str_file_or_path</span><span class="p">);</span>
          <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">__watchedItems</span><span class="p">[</span><span class="nx">str_file_or_path</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">stat</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">stat</span><span class="p">.</span><span class="nx">isFile</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__file</span><span class="p">(</span><span class="nx">add</span><span class="p">,</span> <span class="nx">str_file_or_path</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">stat</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__dir</span><span class="p">(</span><span class="nx">add</span><span class="p">,</span> <span class="nx">str_file_or_path</span><span class="p">,</span> <span class="nx">recursive</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>
  </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h2>Private method: __dir(boolean, string, recursive)</h2>

<p>walk a dir and pass the files with the 'add' boolean
We put a watch on a folder
but this folder is never reported
it's purely to rescan a changed folder
or detect NEW created files</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Watch</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__dir</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">add</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">recursive</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">recursive</span> <span class="o">=</span> <span class="nx">recursive</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span>


    <span class="k">if</span><span class="p">(</span><span class="nx">add</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">__watchedItems</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">dir</span><span class="p">)){</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">__watchedItems</span><span class="p">[</span><span class="nx">dir</span><span class="p">]</span><span class="o">=</span> <span class="p">{</span> <span class="nx">recursive</span> <span class="o">:</span> <span class="nx">recursive</span> <span class="p">};</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">__rescan</span><span class="p">(</span><span class="nx">add</span><span class="p">,</span><span class="nx">dir</span><span class="p">,</span><span class="nx">recursive</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">fs</span><span class="p">.</span><span class="nx">watchFile</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">curr</span><span class="p">,</span> <span class="nx">prev</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Something about the directory has changed, most
likely a file has been added. Rescan the directory
to see if anything new is found, and tell it to report
any new files to the user.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">self</span><span class="p">.</span><span class="nx">__rescan</span><span class="p">(</span><span class="nx">add</span><span class="p">,</span><span class="nx">dir</span><span class="p">,</span><span class="nx">recursive</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Folder already being watched&#39;</span><span class="p">);</span>
      <span class="p">}</span>

    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">__watchedItems</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">dir</span><span class="p">)){</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">__rescan</span><span class="p">(</span><span class="nx">add</span><span class="p">,</span><span class="nx">dir</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">__watchedItems</span><span class="p">[</span><span class="nx">dir</span><span class="p">].</span><span class="nx">recursive</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
        <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">__watchedItems</span><span class="p">[</span><span class="nx">dir</span><span class="p">];</span>
      <span class="p">}</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">fs</span><span class="p">.</span><span class="nx">unwatchFile</span><span class="p">(</span><span class="nx">dir</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">self</span><span class="p">;</span>
  <span class="p">};</span>
  </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h2>Private method: __file(boolean, string)</h2>

<p>Finally add (add==true) or remove a
file from watching, only files should be passed here,
therefore recursive is obsolete.
Handle only files
In the watch usage, this should not be async</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Watch</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__file</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">add</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">is_file</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">is_file</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="nx">file</span><span class="p">).</span><span class="nx">isFile</span><span class="p">();</span>
    <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
      <span class="nx">is_file</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">is_file</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">self</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">add</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Make sure we don't accidently put multiple watchers on a
single file, as this might cause us to report changes several
times and might also cause a memory leak.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">__watchedItems</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">file</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;File already being watched&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">self</span><span class="p">;</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>It doesn't really matter what we assign to this key right now,
we merely have to assign something.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">self</span><span class="p">.</span><span class="nx">__watchedItems</span><span class="p">[</span><span class="nx">file</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">fs</span><span class="p">.</span><span class="nx">watchFile</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">watchMe</span><span class="p">(</span><span class="nx">prev</span><span class="p">,</span> <span class="nx">curr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>This will cause an error
when a file is deleted</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="kd">var</span> <span class="nx">stat</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="nx">file</span><span class="p">).</span><span class="nx">isFile</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Else, register a change</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="nx">prev</span><span class="p">.</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">!==</span> <span class="nx">curr</span><span class="p">.</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">getTime</span><span class="p">())</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;change&quot;</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">prev</span><span class="p">,</span> <span class="nx">curr</span><span class="p">,</span><span class="s1">&#39;change&#39;</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>A file inside the directory has been removed, emit event  </p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="s1">&#39;ENOENT&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;change&quot;</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">prev</span><span class="p">,</span> <span class="nx">curr</span><span class="p">,</span><span class="s1">&#39;delete&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>If this file isn't explicitly being watched, unwatch it now.
Otherwise we'll wait until the user explicitly removes it
from the list</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">__topLvlWatchers</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">self</span><span class="p">.</span><span class="nx">fs</span><span class="p">.</span><span class="nx">unwatchFile</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
              <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">__watchedItems</span><span class="p">[</span><span class="nx">file</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="k">throw</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>console.log('UN WATCH:'+file);</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">self</span><span class="p">.</span><span class="nx">fs</span><span class="p">.</span><span class="nx">unwatchFile</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
      <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">__watchedItems</span><span class="p">[</span><span class="nx">file</span><span class="p">];</span>
    <span class="p">}</span>  
    <span class="k">return</span> <span class="nx">self</span><span class="p">;</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Walk a dir and start watching FILES (only Files),
if add === false STOP listening
if recursive? Walk the tree, but only ADD files for listening
if reportNew? emit the change event for any file we find that wasn't being watched before</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Watch</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__rescan</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">add</span><span class="p">,</span><span class="nx">folder</span><span class="p">,</span> <span class="nx">recursive</span><span class="p">,</span> <span class="nx">reportNew</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">folder</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">stat</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">code</span> <span class="o">!==</span> <span class="s1">&#39;ENOENT&#39;</span><span class="p">){</span>
          <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>The watched directory has been deleted, so if it's part of
a recursively watched directory remove it's watcher.
We won't need to call anything recursively to remove watchers
for any descendants because they to will have been deleted and
have this callback.</p>

<p>But what when we want to remove a watched folder, and
this folder is not deleted</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;__rescan&#39;</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">__topLvlWatchers</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">folder</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">fs</span><span class="p">.</span><span class="nx">unwatchFile</span><span class="p">(</span><span class="nx">folder</span><span class="p">);</span>
          <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">__watchedItems</span><span class="p">[</span><span class="nx">folder</span><span class="p">];</span>
          
        <span class="p">}</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="kd">var</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">folder</span><span class="p">);</span>
        <span class="nx">files</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">full_path</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">folder</span><span class="p">,</span> <span class="nx">file</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">stat</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>We only need to check this path if we aren't already watching it,
or if we need to remove it and all of it's possible descendants.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">add</span> <span class="o">||</span> <span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">__watchedItems</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">full_path</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">stat</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="nx">full_path</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">stat</span><span class="p">.</span><span class="nx">isFile</span><span class="p">())</span> <span class="p">{</span>
              <span class="nx">self</span><span class="p">.</span><span class="nx">__file</span><span class="p">(</span><span class="nx">add</span><span class="p">,</span> <span class="nx">full_path</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>if we aren't in the process of removing listeners and we get to
this point we have a new file that should be reported if this
isn't the initial scan of a directory.</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="k">if</span> <span class="p">(</span><span class="nx">add</span> <span class="o">&amp;&amp;</span> <span class="nx">reportNew</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="nx">full_path</span><span class="p">,</span> <span class="nx">stat</span><span class="p">,</span> <span class="nx">stat</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">);</span>
              <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>If we read a directory, call recursively to <code>__dir</code> method
to be able to handle changes in files inside this directory</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">recursive</span> <span class="o">&amp;&amp;</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">())</span> <span class="p">{</span>
              <span class="nx">self</span><span class="p">.</span><span class="nx">__dir</span><span class="p">(</span><span class="nx">add</span><span class="p">,</span> <span class="nx">full_path</span><span class="p">,</span> <span class="nx">recursive</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">Watch</span><span class="p">;</span>
<span class="p">}();</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WatchClass</span><span class="p">;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 